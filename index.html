<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radar Cidadão</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0d6efd;
      --gradient-start: #0d6efd;
      --gradient-end: #0558d1;
      --light-background: #f4f7f6;
      --light-card-background: #ffffff;
      --light-text: #333;
      --light-muted-text: #555;
      --light-input-background: #f8f9fa;
      
      --dark-background: #121212;
      --dark-card-background: #1e1e1e;
      --dark-text: #e0e0e0;
      --dark-muted-text: #a0a0a0;
      --dark-input-background: #2a2a2a;
    }

    html {
        font-size: 16px; /* Base font size */
        transition: font-size 0.2s ease-in-out;
    }
    /* Font size classes */
    html.font-size-small { font-size: 14px; }
    html.font-size-large { font-size: 18px; }
    html.font-size-xlarge { font-size: 20px; }

    body {
      background-color: var(--light-background);
      padding-top: 2rem;
      padding-bottom: 2rem;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      transition: background-color 0.3s ease;
    }
    
    body.dark-mode {
      background-color: var(--dark-background);
    }

    /* --- Tela de Abertura --- */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--light-background);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 1000;
      transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    body.dark-mode #splash-screen { background-color: var(--dark-background); }
    #splash-screen.hidden { opacity: 0; visibility: hidden; }

    .splash-logo {
      width: 80px; height: 80px;
      animation: fadeInScale 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    .splash-title {
      font-size: 2rem; font-weight: 700; color: var(--light-text);
      margin-top: 1rem; opacity: 0;
      animation: fadeIn 1s ease-in 0.5s forwards;
    }
    body.dark-mode .splash-title { color: var(--dark-text); }
    .splash-subtitle {
      font-size: 1.1rem; color: var(--light-muted-text);
      margin-top: 0.5rem; opacity: 0; height: 2em;
      animation: fadeIn 1s ease-in 1s forwards;
    }
    body.dark-mode .splash-subtitle { color: var(--dark-muted-text); }

    /* --- Conteúdo Principal --- */
    #main-content { opacity: 0; transition: opacity 0.8s ease-in; }
    #main-content.visible { opacity: 1; }
    
    .container { max-width: 600px; }
    .card {
      border: none; border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      background-color: var(--light-card-background);
      transition: background-color 0.3s ease;
    }
    body.dark-mode .card { background-color: var(--dark-card-background); }

    .card-title { font-size: 2rem; font-weight: 700; color: var(--light-text); transition: color 0.3s ease; }
    body.dark-mode .card-title { color: var(--dark-text); }
    
    .greeting { color: var(--light-muted-text); font-size: 1.1rem; transition: color 0.3s ease; }
    body.dark-mode .greeting, body.dark-mode .form-label { color: var(--dark-muted-text); }

    .form-control, .form-select {
      font-size: 1rem;
      border-radius: 0.5rem; padding: 0.75rem 1rem;
      background-color: var(--light-input-background);
      border-color: #dee2e6; color: var(--light-text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode .form-control, body.dark-mode .form-select {
      background-color: var(--dark-input-background);
      border-color: #444; color: var(--dark-text);
    }
    body.dark-mode .form-control::placeholder { color: #777; }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        background-color: var(--light-card-background);
    }
    body.dark-mode .form-control:focus, body.dark-mode .form-select:focus { background-color: var(--dark-card-background); }

    /* --- Funcionalidades UI --- */
    .form-group-animated {
      opacity: 0; transform: translateY(20px);
      animation: slideUpFadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    .is-invalid-shake { animation: shake 0.5s; border-color: #dc3545 !important; }
    
    #char-counter { font-size: 0.8rem; color: var(--light-muted-text); text-align: right; }
    body.dark-mode #char-counter { color: var(--dark-muted-text); }
    
    .btn { font-size: 1rem; }
    .btn-primary {
      background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
      border: none; border-radius: 0.5rem;
      padding: 0.85rem; font-weight: 500;
      transition: all 0.2s ease-in-out;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    }
    
    /* --- Controles de Acessibilidade --- */
    .accessibility-controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        z-index: 20;
    }
    .font-size-controls button, #audio-toggle-btn {
        background-color: var(--light-input-background);
        border: 1px solid #ddd;
        color: var(--light-text);
        width: 34px;
        height: 34px;
        border-radius: 50%;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .font-size-controls button:hover, #audio-toggle-btn:hover { background-color: #e2e6ea; }
    .font-size-controls button:focus-visible, #audio-toggle-btn:focus-visible { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); outline: none; }
    body.dark-mode .font-size-controls button, body.dark-mode #audio-toggle-btn {
        background-color: var(--dark-input-background);
        border-color: #444;
        color: var(--dark-text);
    }
    body.dark-mode .font-size-controls button:hover, body.dark-mode #audio-toggle-btn:hover { background-color: #3a3a3a; }

    /* --- Interruptor de Tema --- */
    .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
    .theme-switch input { display:none; }
    .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
    .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(24px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }

    /* --- Mensagem de Sucesso --- */
    #success-message h4 { font-size: 1.5rem; }
    #protocol-number {
      font-weight: bold; font-size: 1.2rem;
      color: var(--primary-color); background-color: rgba(13, 110, 253, 0.1);
      padding: 0.5rem 1rem; border-radius: 0.5rem;
      display: inline-block; user-select: all;
    }
    #post-submission-info {
        background-color: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 0.95rem;
        text-align: left;
    }
    body.dark-mode #post-submission-info {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }


    /* --- Animações --- */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInScale { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes slideUpFadeIn { to { opacity: 1; transform: translateY(0); } }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); }
    }
  </style>
</head>
<body>

<div id="splash-screen">
  <svg class="splash-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="#0d6efd" stroke-width="1.5"/><path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#0d6efd" stroke-width="1.5"/><path d="M12 2V3" stroke="#0d6efd" stroke-width="1.5"/><path d="M12 21V22" stroke="#0d6efd" stroke-width="1.5"/><path d="M22 12H21" stroke="#0d6efd" stroke-width="1.5"/><path d="M3 12H2" stroke="#0d6efd" stroke-width="1.5"/></svg>
  <h1 class="splash-title">Radar Cidadão</h1>
  <p class="splash-subtitle" id="splash-subtitle"></p>
</div>

<div id="main-content">
  <div class="container">
    <div class="card shadow-sm position-relative">
      <div class="accessibility-controls">
        <div class="font-size-controls d-flex gap-2">
            <button id="font-decrease-btn" aria-label="Diminuir tamanho da fonte">A-</button>
            <button id="font-increase-btn" aria-label="Aumentar tamanho da fonte">A+</button>
        </div>
        <button id="audio-toggle-btn" aria-label="Ativar ou desativar áudio de abertura">
            <svg id="audio-on-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.482 5.482 0 0 1 11.025 8a5.482 5.482 0 0 1-1.61 3.89l.706.706z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/></svg>
            <svg id="audio-off-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-volume-mute-fill d-none" viewBox="0 0 16 16"><path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zm7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/></svg>
        </button>
        <label class="theme-switch">
          <input type="checkbox" id="theme-toggle" />
          <div class="slider round"></div>
        </label>
      </div>
      <div class="card-body p-4 p-md-5">
        <div id="form-container">
            <div class="text-center mb-4">
                <h3 class="card-title">Radar Cidadão</h3>
                <p id="greeting" class="greeting"></p>
            </div>
            <form id="radarForm" novalidate>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.1s;"> <label for="nome" class="form-label">Nome Completo *</label> <input id="nome" name="nome" type="text" class="form-control" required> </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.2s;"> <label for="email" class="form-label">E-mail</label> <input id="email" name="email" type="email" class="form-control" placeholder="seunome@email.com"> </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.3s;"> <label for="telefone" class="form-label">Telefone / WhatsApp</label> <input id="telefone" name="telefone" type="tel" class="form-control" placeholder="(11) 99999-9999" maxlength="15"> </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.4s;">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label for="endereco" class="form-label mb-0">Endereço da Ocorrência</label>
                    <button type="button" id="getLocationBtn" class="btn btn-outline-primary btn-sm"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt" viewBox="0 0 16 16"> <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/> <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/> </svg> <span>Usar Localização</span> </button>
                </div>
                <input id="endereco" name="endereco" type="text" class="form-control" placeholder="Rua, Número, Bairro...">
              </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.5s;">
                <label for="categoria" class="form-label">Categoria</label>
                <select id="categoria" name="categoria" class="form-select"> <option>Buraco na via</option> <option>Iluminação pública</option> <option>Vazamento de água</option> <option>Limpeza de terreno / Lixo</option> <option>Poluição sonora</option> <option>Poluição visual</option> <option>Segurança pública</option> <option>Saúde</option> <option>Outro</option> </select>
              </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.6s;">
                <label for="descricao" class="form-label">Descreva o que aconteceu *</label>
                <textarea id="descricao" name="descricao" rows="5" class="form-control" required maxlength="1000"></textarea>
                <div id="char-counter">0 / 1000</div>
              </div>
              <div class="mb-3 form-group-animated" style="animation-delay: 0.7s;">
                  <label for="imagem" class="form-label">Anexar uma Foto (Opcional)</label>
                  <input class="form-control" type="file" id="imagem" name="imagem" accept="image/*">
                  <div class="text-center"> <img id="imagePreview" src="" alt="Pré-visualização da imagem" style="display: none;" /> </div>
              </div>
              <div class="form-group-animated" style="animation-delay: 0.8s;">
                <button type="submit" id="submitButton" class="btn btn-primary w-100 mt-3"> <span id="buttonText">Enviar Ocorrência</span> <span id="buttonSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span> </button>
              </div>
            </form>
        </div>
        <div id="success-message" class="d-none text-center">
            <h4 class="text-success">Ocorrência Registrada!</h4>
            <p>Obrigado por fazer a sua parte por uma cidade melhor. O seu registo foi enviado com sucesso.</p>
            
            <div id="post-submission-info" class="mt-3 p-3 rounded">
                <!-- Conteúdo dinâmico inserido via JS -->
            </div>

            <p class="mt-4">O seu número de protocolo é:</p>
            <p id="protocol-number"></p>
            <button id="newReportBtn" class="btn btn-primary w-100 mt-4">Registar Nova Ocorrência</button>
        </div>
        <div id="status" class="mt-3 text-center"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwGNgH2vRKmjGYgIKJbdw3eoj0xOFdgq9LiM30sJolC5poMEJknG1uxFAHVmfqgAGt/exec';

  document.addEventListener('DOMContentLoaded', function() {
    const splashScreen = document.getElementById('splash-screen');
    const mainContent = document.getElementById('main-content');
    const subtitle = document.getElementById('splash-subtitle');
    const greetingEl = document.getElementById('greeting');
    
    // --- LÓGICA DE ABERTURA ---
    const textToType = "A sua voz para uma cidade melhor.";
    let i = 0;
    function typeWriter() {
      if (i < textToType.length) {
        subtitle.innerHTML += textToType.charAt(i); i++;
        setTimeout(typeWriter, 50);
      }
    }
    
    setTimeout(() => {
        typeWriter();
        speakWelcomeMessage();
    }, 1200);

    setTimeout(() => {
      splashScreen.classList.add('hidden');
      document.body.style.overflow = 'auto';
      mainContent.classList.add('visible');
    }, 3500);

    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) { greetingEl.textContent = 'Bom dia! Pronto para registrar uma ocorrência?'; }
    else if (hour >= 12 && hour < 18) { greetingEl.textContent = 'Boa tarde! Qual a ocorrência de hoje?'; }
    else { greetingEl.textContent = 'Boa noite! Como podemos ajudar?'; }
  });

  // --- Seletores de Elementos ---
  const form = document.getElementById('radarForm');
  const statusDiv = document.getElementById('status');
  const submitButton = document.getElementById('submitButton');
  const phoneInput = document.getElementById('telefone');
  const descriptionInput = document.getElementById('descricao');
  const charCounter = document.getElementById('char-counter');
  const formContainer = document.getElementById('form-container');
  const successContainer = document.getElementById('success-message');
  const newReportBtn = document.getElementById('newReportBtn');
  
  // --- LÓGICA DE ACESSIBILIDADE ---
  const themeToggle = document.getElementById('theme-toggle');
  const audioToggleBtn = document.getElementById('audio-toggle-btn');
  const fontIncreaseBtn = document.getElementById('font-increase-btn');
  const fontDecreaseBtn = document.getElementById('font-decrease-btn');
  const audioOnIcon = document.getElementById('audio-on-icon');
  const audioOffIcon = document.getElementById('audio-off-icon');

  const fontSizes = ['small', 'default', 'large', 'xlarge'];
  let currentFontIndex = 1;

  // Tema
  themeToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });
  
  // Áudio
  audioToggleBtn.addEventListener('click', () => {
    const isMuted = localStorage.getItem('audioMuted') === 'true';
    localStorage.setItem('audioMuted', !isMuted);
    updateAudioIcons();
  });

  function updateAudioIcons() {
    const isMuted = localStorage.getItem('audioMuted') === 'true';
    audioOnIcon.classList.toggle('d-none', isMuted);
    audioOffIcon.classList.toggle('d-none', !isMuted);
  }

  function speakWelcomeMessage() {
    if (localStorage.getItem('audioMuted') === 'true' || typeof SpeechSynthesisUtterance === 'undefined') return;
    const utterance = new SpeechSynthesisUtterance("Bem-vindo ao Radar Cidadão. A sua voz para uma cidade melhor.");
    utterance.lang = 'pt-BR';
    speechSynthesis.speak(utterance);
  }

  // Tamanho da Fonte
  fontIncreaseBtn.addEventListener('click', () => {
    if (currentFontIndex < fontSizes.length - 1) {
      currentFontIndex++;
      applyFontSize();
    }
  });

  fontDecreaseBtn.addEventListener('click', () => {
    if (currentFontIndex > 0) {
      currentFontIndex--;
      applyFontSize();
    }
  });

  function applyFontSize() {
    const sizeClass = fontSizes[currentFontIndex];
    document.documentElement.className = ''; // Limpa classes antigas de fonte
    if (sizeClass !== 'default') {
        document.documentElement.classList.add(`font-size-${sizeClass}`);
    }
    localStorage.setItem('fontSize', sizeClass);
  }
  
  // Aplicar preferências guardadas ao carregar
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark-mode');
    themeToggle.checked = true;
  }
  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize && fontSizes.includes(savedFontSize)) {
    currentFontIndex = fontSizes.indexOf(savedFontSize);
  }
  applyFontSize();
  updateAudioIcons();


  // --- LÓGICA DO FORMULÁRIO ---
  descriptionInput.addEventListener('input', () => { charCounter.textContent = `${descriptionInput.value.length} / 1000`; });
  phoneInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '').slice(0, 11);
    value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value;
  });

  const imageInput = document.getElementById('imagem');
  const imagePreview = document.getElementById('imagePreview');
  const getLocationBtn = document.getElementById('getLocationBtn');
  const addressInput = document.getElementById('endereco');

  getLocationBtn.addEventListener('click', () => {
    if (!navigator.geolocation) { showError('Geolocalização não é suportada pelo seu navegador.'); return; }
    const originalBtnContent = getLocationBtn.innerHTML;
    getLocationBtn.disabled = true;
    getLocationBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> A obter...`;
    navigator.geolocation.getCurrentPosition(
      (position) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
          .then(response => response.json()).then(data => {
            if (data && data.display_name) { addressInput.value = data.display_name; } else { showError('Não foi possível converter as coordenadas em endereço.'); }
            getLocationBtn.disabled = false; getLocationBtn.innerHTML = originalBtnContent;
          }).catch(() => { showError('Erro ao procurar o serviço de endereço.'); getLocationBtn.disabled = false; getLocationBtn.innerHTML = originalBtnContent; });
      }, () => { showError('Não foi possível obter a sua localização. Verifique as permissões do navegador.'); getLocationBtn.disabled = false; getLocationBtn.innerHTML = originalBtnContent; }
    );
  });
  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = 'block'; };
      reader.readAsDataURL(file);
    } else { imagePreview.src = ''; imagePreview.style.display = 'none'; }
  });
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    let isFormValid = true;
    form.querySelectorAll('[required]').forEach(field => {
        field.classList.remove('is-invalid-shake');
        if (!field.value.trim()) { isFormValid = false; field.classList.add('is-invalid-shake'); }
    });
    if (!isFormValid) {
        showError('Por favor, preencha os campos obrigatórios.');
        setTimeout(() => { form.querySelectorAll('[required]').forEach(field => field.classList.remove('is-invalid-shake')); }, 1000);
        return;
    }
    setLoading(true);
    const file = imageInput.files[0];
    const data = Object.fromEntries(new FormData(form));
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const [meta, base64String] = event.target.result.split(',');
        data.imagemBase64 = base64String; data.imagemMimeType = file.type; data.imagemNome = file.name;
        sendData(data);
      };
      reader.onerror = () => { showError('Não foi possível ler o ficheiro de imagem.'); };
      reader.readAsDataURL(file);
    } else { sendData(data); }
  });
  function sendData(data) {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) })
    .then(response => response.json())
    .then(result => {
      if (result.status === 'success') {
        const protocol = `RC-${Date.now()}`;
        document.getElementById('protocol-number').textContent = protocol;

        const postSubmissionInfo = document.getElementById('post-submission-info');
        let specificMessage = '';

        if (data.categoria === 'Poluição sonora') {
          specificMessage = `<p class="mb-2"><strong>Atenção:</strong> Para ocorrências de poluição sonora, a nossa equipe irá analisar e, se necessário, monitorizar o local para fins de esclarecimento.</p>`;
        } else if (data.categoria === 'Buraco na via') {
          specificMessage = `<p class="mb-2"><strong>Ação Imediata:</strong> A sua ocorrência sobre buracos na via já foi encaminhada para o setor de manutenção e obras.</p>`;
        }

        const generalMessage = `
          <p class="mb-1 fst-italic">As informações prestadas são direcionadas à prefeitura de imediato.</p>
          <p class="mb-0 fst-italic">Todo registo é armazenado e analisado para prezarmos pela eficiência dos serviços na nossa cidade.</p>
        `;

        postSubmissionInfo.innerHTML = specificMessage + generalMessage;
        
        formContainer.classList.add('d-none');
        successContainer.classList.remove('d-none');
      } else { throw new Error(result.message || 'Ocorreu um erro desconhecido.'); }
    })
    .catch(error => { showError(`<strong>Erro ao enviar:</strong> ${error.message}`); })
    .finally(() => setLoading(false));
  }
  newReportBtn.addEventListener('click', () => {
    successContainer.classList.add('d-none');
    formContainer.classList.remove('d-none');
    form.reset();
    imagePreview.style.display = 'none';
    charCounter.textContent = '0 / 1000';
    statusDiv.innerHTML = '';
  });
  function showError(message) {
      setLoading(false); console.error('Erro:', message);
      statusDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
  }
  function setLoading(isLoading) {
    submitButton.disabled = isLoading;
    submitButton.querySelector('#buttonText').textContent = isLoading ? 'A Enviar...' : 'Enviar Ocorrência';
    submitButton.querySelector('#buttonSpinner').style.display = isLoading ? 'inline-block' : 'none';
  }
</script>
</body>
</html>

