<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Radar Cidad√£o</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Bibliotecas para PDF e Som -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    :root {
      --primary-color: #007BFF;
      --gradient-start: #0d6efd;
      --gradient-end: #0056b3;
      --background-color: #f7f9fc;
      --card-background-color: #ffffff;
      --text-color: #212529;
      --muted-text-color: #6c757d;
      --input-background-color: #f8f9fa;
      --progress-background: #e9ecef;
      --border-color: #dee2e6;
      --success-color: #198754;
    }

    body {
      background-color: var(--background-color);
      padding-top: 2rem;
      padding-bottom: 2rem;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* --- Tela de Abertura --- */
    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: var(--background-color);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 1000;
      transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    #splash-screen.hidden { opacity: 0; visibility: hidden; }
    
    .splash-scene { width: 250px; height: auto; }
    .splash-scene .draw-path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw 2s ease-out forwards; }
    .splash-scene .fill-shape { opacity: 0; animation: fill-in 1s ease-in forwards; }

    .splash-title { font-size: 2.2rem; font-weight: 700; color: var(--text-color); margin-top: 1rem; opacity: 0; animation: fadeIn 1s ease-in forwards; animation-delay: 2.5s; }
    .splash-subtitle { font-size: 1.1rem; color: var(--muted-text-color); margin-top: 0.5rem; opacity: 0; height: 2em; animation: fadeIn 1s ease-in forwards; animation-delay: 3s; }

    /* --- Conte√∫do Principal --- */
    #main-content { opacity: 0; transition: opacity 0.8s ease-in; }
    #main-content.visible { opacity: 1; }
    
    .container { max-width: 600px; perspective: 1000px; }
    .card-flipper { transition: transform 0.8s; transform-style: preserve-3d; }
    .card-flipper.is-flipped { transform: rotateY(180deg); }

    .card {
      border: none; border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      background-color: var(--card-background-color);
      position: absolute; width: 100%;
      backface-visibility: hidden;
    }
    .card-back { transform: rotateY(180deg); }

    .card-title { font-size: 2rem; font-weight: 700; color: var(--text-color); }
    
    .greeting { color: var(--muted-text-color); font-size: 1.1rem; height: auto; min-height: 1.5em; }

    /* --- Logo de Radar Animado no Formul√°rio --- */
    .radar-logo-container { height: 60px; margin-bottom: 1rem; }
    .radar-logo { width: 60px; height: 60px; }
    .radar-sweep { transform-origin: center; animation: radar-sweep 3s linear infinite; }

    /* --- Barra de Progresso --- */
    .progress-container { margin-bottom: 2rem; }
    .progress { height: 10px; border-radius: 5px; background-color: var(--progress-background); overflow: visible; }
    .progress-bar { background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1); position: relative; }
    .progress-bar-label { color: var(--muted-text-color); font-size: 0.85rem; font-weight: 500; text-align: center; margin-top: 0.5rem; }

    /* --- Formul√°rio --- */
    .form-step { display: none; }
    .form-step.active { display: block; animation: slideUpFadeIn 0.5s forwards; }
    .is-invalid-shake { animation: shake 0.5s; border-color: #dc3545 !important; }

    .form-control, .form-select {
      font-size: 1rem; border-radius: 0.5rem; padding: 0.75rem 1rem;
      background-color: var(--input-background-color); border: 1px solid var(--border-color); color: var(--text-color);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.2); background-color: var(--card-background-color); }
    
    .btn-primary { background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)); border: none; border-radius: 0.5rem; padding: 0.85rem; font-weight: 500; transition: all 0.2s ease-in-out; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
    
    .sub-category-wrapper { display: none; animation: slideUpFadeIn 0.4s; }

    /* --- Elementos Inteligentes --- */
    #motivational-quote { background-color: rgba(0, 123, 255, 0.05); border-left: 4px solid var(--primary-color); padding: 1rem; margin-bottom: 1.5rem; font-style: italic; color: var(--muted-text-color); opacity: 0; animation: fadeIn 0.5s 0.2s forwards; }
    .category-wrapper { position: relative; }
    #ai-suggestion {
        position: absolute;
        top: 0;
        right: 0;
        transform: translateY(-90%);
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        background-color: #e7f3ff;
        border-radius: 1rem;
        display: none;
        animation: fadeIn 0.5s;
        z-index: 10;
        white-space: nowrap;
    }
    
    /* --- Mensagem de Sucesso --- */
    #success-message h4 { font-size: 1.5rem; color: var(--success-color); }
    #post-submission-info { background-color: var(--input-background-color); border: 1px solid var(--border-color); font-size: 0.95rem; text-align: left; }

    /* --- Bot√£o de Ajuda e Modal --- */
    .help-fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 28px; font-weight: bold; border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 999; transition: transform 0.2s ease; display: flex; align-items: center; justify-content: center; }
    .help-fab:hover { transform: scale(1.1); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background-color: var(--card-background-color); padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s ease; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
    .faq-item { margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
    .faq-item h5 { font-weight: bold; color: var(--primary-color); }

    /* --- Anima√ß√µes --- */
    @keyframes radar-sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes draw { to { stroke-dashoffset: 0; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fill-in { to { opacity: 1; } }
    @keyframes slideUpFadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
  </style>
</head>
<body>

<div id="splash-screen">
  <svg class="splash-scene" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
    <style> #building1 { animation-delay: 0.5s; } #building2 { animation-delay: 0.8s; } #building3 { animation-delay: 1.1s; } #tree1-trunk { animation-delay: 1.5s; } #tree1-leaves { animation-delay: 2s; } #tree2-trunk { animation-delay: 1.7s; } #tree2-leaves { animation-delay: 2.2s; } #sun { animation-delay: 2.5s; } </style>
    <circle id="sun" class="fill-shape" cx="180" cy="20" r="10" fill="#FFD700"/>
    <path id="building1" class="draw-path" d="M 40 90 V 40 H 70 V 90" stroke="#6c757d" stroke-width="1" fill="rgba(200,200,200,0.5)" />
    <path id="building2" class="draw-path" d="M 80 90 V 20 H 120 V 90" stroke="#6c757d" stroke-width="1" fill="rgba(180,180,180,0.5)" />
    <path id="building3" class="draw-path" d="M 130 90 V 50 H 155 V 90" stroke="#6c757d" stroke-width="1" fill="rgba(220,220,220,0.5)" />
    <path id="tree1-trunk" class="draw-path" d="M 20 90 V 70" stroke="#8B4513" stroke-width="1.5" />
    <circle id="tree1-leaves" class="fill-shape" cx="20" cy="60" r="12" fill="#228B22" />
    <path id="tree2-trunk" class="draw-path" d="M 170 90 V 75" stroke="#8B4513" stroke-width="1.5" />
    <circle id="tree2-leaves" class="fill-shape" cx="170" cy="65" r="10" fill="#2E8B57" />
    <path id="ground" class="draw-path" d="M0 90 H200" stroke="#6c757d" stroke-width="2" />
  </svg>
  <h1 class="splash-title">Radar Cidad√£o</h1>
  <p class="splash-subtitle" id="splash-subtitle"></p>
</div>

<div id="main-content">
  <div class="container">
    <div class="position-relative">
      <div id="card-flipper" class="card-flipper">
        <!-- Frente do Cart√£o: Formul√°rio -->
        <div class="card card-front">
          <div class="card-body p-4 p-md-5">
            <div id="form-container">
                <div class="text-center mb-4">
                    <div class="radar-logo-container">
                        <svg class="radar-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="45" stroke="#007BFF" stroke-width="1" fill="none" opacity="0.3"/>
                            <circle cx="50" cy="50" r="30" stroke="#007BFF" stroke-width="1" fill="none" opacity="0.3"/>
                            <circle cx="50" cy="50" r="15" stroke="#007BFF" stroke-width="1" fill="none" opacity="0.3"/>
                            <line x1="50" y1="50" x2="50" y2="5" stroke="#007BFF" stroke-width="2" class="radar-sweep"/>
                        </svg>
                    </div>
                    <h3 class="card-title">Radar Cidad√£o</h3>
                    <p id="greeting" class="greeting"></p>
                </div>

                <div class="progress-container">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 33.33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="progress-bar-label" class="progress-bar-label">Etapa 1 de 3</div>
                </div>

                <form id="radarForm" novalidate>
                  <div class="form-step active" data-step="1">
                    <h5 class="mb-3">1. Identifica√ß√£o</h5>
                    <div class="mb-3"> <label for="nome" class="form-label">Nome Completo (Opcional)</label> <input id="nome" name="nome" type="text" class="form-control"> </div>
                    <div class="mb-3"> <label for="email" class="form-label">E-mail</label> <input id="email" name="email" type="email" class="form-control" placeholder="seunome@email.com"> </div>
                    <div class="mb-3"> <label for="telefone" class="form-label">Telefone / WhatsApp</label> <input id="telefone" name="telefone" type="tel" class="form-control" placeholder="(11) 99999-9999" maxlength="15"> </div>
                    <div class="d-flex justify-content-end mt-4"> <button type="button" class="btn btn-primary next-btn">Avan√ßar</button> </div>
                  </div>
                  <div class="form-step" data-step="2">
                    <h5 class="mb-3">2. Ocorr√™ncia</h5>
                    <div id="motivational-quote"></div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label for="endereco" class="form-label mb-0">Endere√ßo da Ocorr√™ncia</label>
                            <button type="button" id="getLocationBtn" class="btn btn-outline-primary btn-sm"> 
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pin-map" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M3.1 11.2a.5.5 0 0 1 .4-.2H6a.5.5 0 0 1 0 1H3.75L1.5 15h13l-2.25-3H10a.5.5 0 0 1 0-1h2.5a.5.5 0 0 1 .4.2l3 4a.5.5 0 0 1-.4.8H.5a.5.5 0 0 1-.4-.8l3-4z"/> <path fill-rule="evenodd" d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999z"/> </svg>
                              <span>Usar Localiza√ß√£o</span> 
                            </button>
                        </div>
                        <input id="endereco" name="endereco" type="text" class="form-control" placeholder="Rua, N√∫mero, Bairro...">
                    </div>
                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descreva o que aconteceu *</label>
                        <textarea id="descricao" name="descricao" rows="5" class="form-control" required maxlength="1000"></textarea>
                    </div>
                    <div class="mb-3 category-wrapper">
                        <label for="categoria" class="form-label">Categoria</label>
                        <div id="ai-suggestion"></div>
                        <select id="categoria" name="categoria" class="form-select"> <option value="">Selecione a categoria</option><option>Buraco na via</option> <option>Ilumina√ß√£o p√∫blica</option> <option>Vazamento de √°gua</option> <option>Limpeza de terreno / Lixo</option> <option>Polui√ß√£o sonora</option> <option>Polui√ß√£o visual</option> <option>Seguran√ßa p√∫blica</option> <option>Sa√∫de</option> <option>Outro</option> </select>
                    </div>
                    <div id="sub-categoria-iluminacao" class="mb-3 sub-category-wrapper"> <label for="sub-categoria-iluminacao-select" class="form-label">Qual o problema de ilumina√ß√£o?</label> <select id="sub-categoria-iluminacao-select" class="form-select"> <option>Poste com l√¢mpada queimada</option><option>Poste danificado ou ca√≠do</option><option>Fios soltos ou em risco</option><option>V√°rios postes apagados na rua</option> </select> </div>
                    <div id="sub-categoria-agua" class="mb-3 sub-category-wrapper"> <label for="sub-categoria-agua-select" class="form-label">Onde √© o vazamento?</label> <select id="sub-categoria-agua-select" class="form-select"> <option>Na rua / asfalto</option><option>Na cal√ßada</option><option>Em terreno baldio / √°rea de grama</option> </select> </div>
                    <div class="d-flex justify-content-between mt-4"> <button type="button" class="btn btn-secondary prev-btn">Voltar</button> <button type="button" class="btn btn-primary next-btn">Avan√ßar</button> </div>
                  </div>
                  <div class="form-step" data-step="3">
                    <h5 class="mb-3">3. Evid√™ncia</h5>
                    <div class="mb-3">
                        <label for="imagem" class="form-label">Anexar uma Foto (Opcional)</label>
                        <input class="form-control" type="file" id="imagem" name="imagem" accept="image/*">
                        <div class="text-center"> <img id="imagePreview" class="mt-3 rounded" src="" alt="Pr√©-visualiza√ß√£o da imagem" style="display: none; max-width: 100%; max-height: 200px; border: 1px solid #ddd; padding: 4px;" /> </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4"> <button type="button" class="btn btn-secondary prev-btn">Voltar</button> <button type="submit" id="submitButton" class="btn btn-primary"> <span id="buttonText">Enviar Ocorr√™ncia</span> <span id="buttonSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span> </button> </div>
                  </div>
                </form>
            </div>
            <div id="status" class="mt-3 text-center"></div>
          </div>
        </div>
        <!-- Verso do Cart√£o: Mensagem de Sucesso -->
        <div class="card card-back">
          <div id="success-message" class="card-body p-4 p-md-5 d-flex flex-column justify-content-center text-center">
            <h4>Ocorr√™ncia Registrada!</h4>
            <p>Obrigado por fazer a sua parte por uma cidade melhor. O seu comprovante em PDF ser√° baixado automaticamente.</p>
            <div id="post-submission-info" class="mt-3 p-3 rounded"></div>
            <p class="mt-4">Se o download n√£o iniciar, <a href="#" id="download-pdf-link">clique aqui</a>.</p>
            <button id="newReportBtn" class="btn btn-primary w-100 mt-auto">Registrar Nova Ocorr√™ncia</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bot√£o de Ajuda Flutuante -->
<button id="help-fab" class="help-fab" aria-label="Abrir assistente de ajuda">?</button>

<!-- Modal de Ajuda -->
<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <span id="modal-close-btn" class="modal-close">&times;</span>
        <h4>Assistente Virtual - Radar Cidad√£o</h4>
        <p>Ol√°! Como posso ajudar? Aqui est√£o algumas perguntas frequentes:</p>
        <div class="faq-item">
            <h5>Como funciona o comprovante em PDF?</h5>
            <p>O PDF √© a sua garantia de que o registro foi recebido. Ele cont√©m um n√∫mero de protocolo √∫nico e todos os detalhes da ocorr√™ncia. Guarde-o para futuras consultas.</p>
        </div>
        <div class="faq-item">
            <h5>Meus dados pessoais est√£o seguros?</h5>
            <p>Sim. Apenas as informa√ß√µes da ocorr√™ncia (local, categoria, descri√ß√£o) s√£o repassadas para a equipe respons√°vel. Seus dados de identifica√ß√£o s√£o mantidos em sigilo.</p>
        </div>
        <div class="faq-item">
            <h5>O que acontece depois que eu envio a ocorr√™ncia?</h5>
            <p>Sua ocorr√™ncia √© enviada diretamente para a secretaria respons√°vel da prefeitura, que dar√° in√≠cio ao processo de verifica√ß√£o e solu√ß√£o do problema.</p>
        </div>
    </div>
</div>


<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwGNgH2vRKmjGYgIKJbdw3eoj0xOFdgq9LiM30sJolC5poMEJknG1uxFAHVmfqgAGt/exec';
  const { jsPDF } = window.jspdf;

  document.addEventListener('DOMContentLoaded', function() {
    const splashScreen = document.getElementById('splash-screen');
    const mainContent = document.getElementById('main-content');
    const subtitle = document.getElementById('splash-subtitle');
    const greetingEl = document.getElementById('greeting');
    const motivationalQuoteEl = document.getElementById('motivational-quote');

    // Som de radar
    let radarSoundInterval;
    const synth = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
    }).toDestination();
    
    // Inicia o som quando a anima√ß√£o come√ßa
    setTimeout(() => {
        Tone.start();
        radarSoundInterval = setInterval(() => {
            synth.triggerAttackRelease("G5", "8n", Tone.now());
        }, 1000);
    }, 500);


    const motivationalQuotes = [
        "A mudan√ßa que voc√™ quer ver na sua cidade come√ßa com a sua atitude.", "Cidadania √© a pr√°tica di√°ria de cuidar do que √© de todos n√≥s.",
        "Voc√™ sabia? Pequenas a√ß√µes, como relatar um problema, geram grandes transforma√ß√µes.", "Cada ocorr√™ncia registrada √© um passo em dire√ß√£o a uma cidade mais segura e eficiente.",
        "A sua participa√ß√£o √© a ferramenta mais poderosa para o bem-estar da nossa comunidade."
    ];
    motivationalQuoteEl.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
    
    const textToType = "A sua voz para uma cidade melhor.";
    
    setTimeout(() => {
        speakWelcomeMessage();
        subtitle.textContent = textToType; // Remove anima√ß√£o de digita√ß√£o
    }, 3000);

    setTimeout(() => {
      splashScreen.classList.add('hidden');
      if (radarSoundInterval) clearInterval(radarSoundInterval); // Para o som
      document.body.style.overflow = 'auto';
      mainContent.classList.add('visible');
    }, 5500);

    const hour = new Date().getHours();
    const bomDiaMessages = [ "Bom dia! Pronto para fazer a diferen√ßa na nossa cidade hoje?", "Bom dia! O sol nasceu, e com ele a oportunidade de melhorar nosso bairro." ];
    const boaTardeMessages = [ "Boa tarde! Uma pequena a√ß√£o sua pode resolver um grande problema.", "Boa tarde! Como podemos ajudar a melhorar a cidade agora?" ];
    const boaNoiteMessages = [
        "Boa noite! Sabia que 90% dos problemas de ilumina√ß√£o reportados aqui s√£o resolvidos em 72 horas?", "Boa noite! Seu registro ajuda a prefeitura a direcionar recursos de forma mais inteligente. Sua participa√ß√£o constr√≥i uma cidade melhor.",
        "Boa noite! No √∫ltimo m√™s, os cidad√£os ajudaram a mapear mais de 200 buracos na via, agilizando os reparos.", "Boa noite! Cidades que usam dados de cidad√£os como voc√™ melhoram em at√© 25% a qualidade dos servi√ßos p√∫blicos."
    ];

    let messages = (hour >= 5 && hour < 12) ? bomDiaMessages : (hour >= 12 && hour < 18) ? boaTardeMessages : boaNoiteMessages;
    greetingEl.textContent = messages[Math.floor(Math.random() * messages.length)];
  });

  function speakWelcomeMessage() {
    if (typeof SpeechSynthesisUtterance === 'undefined') return;
    try {
        const utterance = new SpeechSynthesisUtterance("Bem-vindo ao Radar Cidad√£o. A sua voz para uma cidade melhor.");
        utterance.lang = 'pt-BR';
        speechSynthesis.speak(utterance);
    } catch (error) { console.error("Erro na s√≠ntese de voz:", error); }
  }

  let currentStep = 1;
  const form = document.getElementById('radarForm');
  const cardFlipper = document.getElementById('card-flipper');
  const progressBar = document.getElementById('progress-bar');
  const progressBarLabel = document.getElementById('progress-bar-label');
  const steps = document.querySelectorAll('.form-step');
  const totalSteps = steps.length;

  function showStep(stepNumber) {
    steps.forEach(step => step.classList.remove('active'));
    document.querySelector(`.form-step[data-step="${stepNumber}"]`).classList.add('active');
    updateProgressBar(stepNumber);
  }

  function updateProgressBar(stepNumber) {
    const progress = (stepNumber / totalSteps) * 100 - ((1 / totalSteps) * 100) / 2;
    progressBar.style.width = `${progress}%`;
    progressBarLabel.textContent = `Etapa ${stepNumber} de ${totalSteps}`;
  }
  
  function validateStep(stepNumber) {
    let isValid = true;
    const currentStepElement = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        field.classList.remove('is-invalid-shake');
        if (!field.value.trim()) { isValid = false; field.classList.add('is-invalid-shake'); }
    });

    if (stepNumber === 1) {
        const nomeInput = document.getElementById('nome');
        const nomeValue = nomeInput.value.trim();
        const nomeRegex = /^[a-zA-Z\u00C0-\u017F\s']{3,}$/;
        if (nomeValue && !nomeRegex.test(nomeValue)) {
            isValid = false; nomeInput.classList.add('is-invalid-shake');
            showError('Se preenchido, o nome deve ser v√°lido (m√≠nimo 3 letras, sem n√∫meros ou s√≠mbolos).');
            setTimeout(() => nomeInput.classList.remove('is-invalid-shake'), 1000);
            return false; 
        }
    }
    if (!isValid && !document.querySelector('.alert')) {
        showError('Por favor, preencha os campos obrigat√≥rios.');
        setTimeout(() => { requiredFields.forEach(field => field.classList.remove('is-invalid-shake')); }, 1000);
    }
    return isValid;
  }

  document.querySelectorAll('.next-btn').forEach(button => {
    button.addEventListener('click', () => { if (validateStep(currentStep)) { currentStep++; showStep(currentStep); } });
  });

  document.querySelectorAll('.prev-btn').forEach(button => {
    button.addEventListener('click', () => { currentStep--; showStep(currentStep); });
  });

  const statusDiv = document.getElementById('status');
  const submitButton = document.getElementById('submitButton');
  const phoneInput = document.getElementById('telefone');
  const descriptionInput = document.getElementById('descricao');
  const aiSuggestionEl = document.getElementById('ai-suggestion');
  const newReportBtn = document.getElementById('newReportBtn');
  const imageInput = document.getElementById('imagem');
  const imagePreview = document.getElementById('imagePreview');
  const getLocationBtn = document.getElementById('getLocationBtn');
  const addressInput = document.getElementById('endereco');
  const categoriaSelect = document.getElementById('categoria');

  phoneInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '').slice(0, 11);
    value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value;
  });

  const keywordMap = { 'l√¢mpada': 'Ilumina√ß√£o p√∫blica', 'poste': 'Ilumina√ß√£o p√∫blica', 'escuro': 'Ilumina√ß√£o p√∫blica', 'luz': 'Ilumina√ß√£o p√∫blica', 'buraco': 'Buraco na via', 'asfalto': 'Buraco na via', 'cratera': 'Buraco na via', '√°gua': 'Vazamento de √°gua', 'cano': 'Vazamento de √°gua', 'vazando': 'Vazamento de √°gua', 'lixo': 'Limpeza de terreno / Lixo', 'sujeira': 'Limpeza de terreno / Lixo', 'entulho': 'Limpeza de terreno / Lixo', 'barulho': 'Polui√ß√£o sonora', 'som alto': 'Polui√ß√£o sonora', 'picha√ß√£o': 'Polui√ß√£o visual', 'cartaz': 'Polui√ß√£o visual', 'placa': 'Polui√ß√£o visual', 'assalto': 'Seguran√ßa p√∫blica', 'roubo': 'Seguran√ßa p√∫blica', 'suspeito': 'Seguran√ßa p√∫blica', 'posto': 'Sa√∫de', 'ambul√¢ncia': 'Sa√∫de', 'atendimento': 'Sa√∫de' };
  descriptionInput.addEventListener('input', () => {
      const text = descriptionInput.value.toLowerCase();
      let suggestionMade = false;
      for (const keyword in keywordMap) {
          if (text.includes(keyword)) {
              const category = keywordMap[keyword];
              aiSuggestionEl.innerHTML = `üí° Sugest√£o: <strong>${category}</strong>`;
              aiSuggestionEl.style.display = 'block';
              if (categoriaSelect.value !== category) { categoriaSelect.value = category; categoriaSelect.dispatchEvent(new Event('change')); }
              suggestionMade = true; break;
          }
      }
      if (!suggestionMade) { aiSuggestionEl.style.display = 'none'; }
  });

  categoriaSelect.addEventListener('change', (e) => {
    const selectedCategory = e.target.value;
    document.querySelectorAll('.sub-category-wrapper').forEach(wrapper => {
        wrapper.style.display = 'none';
        const select = wrapper.querySelector('select');
        if (select) { select.removeAttribute('name'); }
    });
    let targetWrapper = null;
    if (selectedCategory === 'Ilumina√ß√£o p√∫blica') { targetWrapper = document.getElementById('sub-categoria-iluminacao'); } 
    else if (selectedCategory === 'Vazamento de √°gua') { targetWrapper = document.getElementById('sub-categoria-agua'); }
    if(targetWrapper) {
      targetWrapper.style.display = 'block';
      targetWrapper.querySelector('select').setAttribute('name', 'detalhe_ocorrencia');
    }
  });

  getLocationBtn.addEventListener('click', () => {
    if (!navigator.geolocation) { showError('Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.'); return; }
    const originalBtnText = getLocationBtn.innerHTML;
    getLocationBtn.disabled = true;
    getLocationBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
    navigator.geolocation.getCurrentPosition( (position) => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
          .then(res => res.json()).then(data => { addressInput.value = data.display_name || ''; })
          .catch(() => showError('Erro ao obter o nome do endere√ßo.'))
          .finally(() => { getLocationBtn.disabled = false; getLocationBtn.innerHTML = originalBtnText; });
      }, () => { showError('N√£o foi poss√≠vel obter a sua localiza√ß√£o.'); getLocationBtn.disabled = false; getLocationBtn.innerHTML = originalBtnText; }
    );
  });

  imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => { imagePreview.src = e.target.result; imagePreview.style.display = 'block'; };
      reader.readAsDataURL(file);
    } else { imagePreview.src = ''; imagePreview.style.display = 'none'; }
  });
  
  let lastSubmittedData = {};
  
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!validateStep(currentStep)) return;
    setLoading(true);

    const protocol = `RC-${Date.now()}`;
    
    const file = imageInput.files[0];
    let data = Object.fromEntries(new FormData(form));
    data.protocolo = protocol;

    const activeSubCategory = document.querySelector('.sub-category-wrapper[style*="block"]');
    if (activeSubCategory) { const subSelect = activeSubCategory.querySelector('select'); if (subSelect && subSelect.name) { data[subSelect.name] = subSelect.value; } }
    
    lastSubmittedData = data;

    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => { const [, base64String] = event.target.result.split(','); data.imagemBase64 = base64String; data.imagemMimeType = file.type; data.imagemNome = file.name; sendData(data); };
      reader.onerror = () => showError('N√£o foi poss√≠vel ler o arquivo de imagem.'); reader.readAsDataURL(file);
    } else { sendData(data); }
  });

  function sendData(data) {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(data) })
    .then(response => response.json())
    .then(result => {
      if (result.status === 'success') {
        const postSubmissionInfo = document.getElementById('post-submission-info');
        let specificMessage = '';
        if (data.categoria === 'Polui√ß√£o sonora') { specificMessage = `<p class="mb-2"><strong>Aten√ß√£o:</strong> Para ocorr√™ncias de polui√ß√£o sonora, nossa equipe ir√° analisar e, se necess√°rio, monitorar o local para fins de esclarecimento.</p>`; } 
        else if (data.categoria === 'Buraco na via') { specificMessage = `<p class="mb-2"><strong>A√ß√£o Imediata:</strong> Sua ocorr√™ncia sobre buracos na via j√° foi encaminhada para o setor de manuten√ß√£o e obras.</p>`; }
        const generalMessage = `<p class="mb-1 fst-italic">As informa√ß√µes prestadas s√£o direcionadas √† prefeitura de imediato.</p><p class="mb-0 fst-italic">Todo registro √© armazenado e analisado para prezarmos pela efici√™ncia dos servi√ßos em nossa cidade.</p>`;
        postSubmissionInfo.innerHTML = specificMessage + generalMessage;
        
        cardFlipper.classList.add('is-flipped');
        generateAndDownloadPDF(lastSubmittedData);
        
      } else { throw new Error(result.message || 'Ocorreu um erro desconhecido.'); }
    })
    .catch(error => { showError(`<strong>Erro ao enviar:</strong> ${error.message}`); })
    .finally(() => setLoading(false));
  }
  
  document.getElementById('download-pdf-link').addEventListener('click', (e) => {
      e.preventDefault();
      if(lastSubmittedData.protocolo) {
        generateAndDownloadPDF(lastSubmittedData);
      }
  });

  newReportBtn.addEventListener('click', () => {
    cardFlipper.classList.remove('is-flipped');
    setTimeout(() => {
        form.reset();
        document.querySelectorAll('.sub-category-wrapper').forEach(wrapper => wrapper.style.display = 'none');
        imagePreview.style.display = 'none';
        aiSuggestionEl.style.display = 'none';
        statusDiv.innerHTML = '';
        currentStep = 1;
        showStep(currentStep);
        const motivationalQuotes = [ "A mudan√ßa que voc√™ quer ver na sua cidade come√ßa com a sua atitude.", "Cidadania √© a pr√°tica di√°ria de cuidar do que √© de todos n√≥s.", "Voc√™ sabia? Pequenas a√ß√µes, como relatar um problema, geram grandes transforma√ß√µes.", "Cada ocorr√™ncia registrada √© um passo em dire√ß√£o a uma cidade mais segura e eficiente.", "A sua participa√ß√£o √© a ferramenta mais poderosa para o bem-estar da nossa comunidade." ];
        document.getElementById('motivational-quote').textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
    }, 400);
  });

  // --- L√ìGICA DO ASSISTENTE VIRTUAL ---
  const helpFab = document.getElementById('help-fab');
  const helpModal = document.getElementById('help-modal');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  function openHelpModal() { helpModal.classList.add('visible'); }
  function closeHelpModal() { helpModal.classList.remove('visible'); }

  helpFab.addEventListener('click', openHelpModal);
  modalCloseBtn.addEventListener('click', closeHelpModal);
  helpModal.addEventListener('click', (e) => { if (e.target === helpModal) { closeHelpModal(); } });


  function showError(message) {
      setLoading(false); console.error('Erro:', message);
      statusDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
      setTimeout(() => { statusDiv.innerHTML = ''; }, 6000);
  }
  function setLoading(isLoading) {
    submitButton.disabled = isLoading;
    submitButton.querySelector('#buttonText').textContent = isLoading ? 'Enviando...' : 'Enviar Ocorr√™ncia';
    submitButton.querySelector('#buttonSpinner').style.display = isLoading ? 'inline-block' : 'none';
  }
</script>
</body>
</html>

